t60.

:- dynamic location/1.
:- dynamic equipment/1.
:- dynamic evacuated/1.
:- dynamic responded/1.
:- dynamic suggestion/1. 
:- dynamic risk_level/1.

alarmE(E, L) :> 
    assert(location(L)), 
    acquire_knowledge(E, Fact), 
    handle_ai_suggestion(Fact),
    assert(Fact),
    evacuateA(E, L), 
    equipA(E).

handle_ai_suggestion(Fact) :-
    arg(1, Fact, Action),
    write('!!! AI SUGGERISCE: '), write(Action), nl.

handle_ai_suggestion(Fact) :-
    write('... Pattern matching fallito. Analisi del termine: '), 
    write_canonical(Fact), nl.

equippedE(E) :> assert(equipment(E)).
evacuatedE(L):> assert(evacuated(L)).
respondedE(L):> assert(responded(L)).

response(E, L) :- location(_), location(L), equipment(_), equipment(E).
responseI(E, L) :> messageA(responder, send_message(respond(E, L), Me)), retract(location(_)), retract(equipment(_)).

done(L) :- evacuated(_), evacuated(L), responded(_), responded(E).
doneI(L) :> logA(message(coordinator, done)), retract(evacuated(_)), retract(responded(_)).

equipA(E):> messageA(manager, send_message(emergency(E), Me)).

evacuateA(E, L):> messageA(communicator,inform(communicate([mary, john], E, communicator), communicator)), messageA(evacuator, send_message(evacuate(L), Me)).

logA(X) :> messageA(logger, send_message(X, Me)).